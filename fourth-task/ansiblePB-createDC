- name: Deploy Drupal with Docker Compose
   hosts: all
   become: true
   vars:
    project_name: "drupal_project"
    drupal_image: "drupal:9"
    db_image: "mysql:5.7"
    db_root_password: "root_password"
    db_name: "drupal_db"
    db_user: "drupal_user"
    db_password: "user_password"
    state: "present" # или "absent" для удаления

   tasks:
    - name: Create docker-compose.yml
      copy:
        dest: "/path/to/{{ project_name }}/docker-compose.yml"
        content: |
         version: '3.7' 
         services:
          drupal:
           image: "{{ drupal_image }}"
           ports:
            - "8080:80"
           environment:
            - DB_HOST=db
            - DB_USER={{ db_user }}
            - DB_PASSWORD={{ db_password }}
            - DB_NAME={{ db_name }}
           depends_on:
            - db
          db:
           image: "{{ db_image }}"
           environment:
            - MYSQL_ROOT_PASSWORD={{ db_root_password }}
            - MYSQL_DATABASE={{ db_name }}
            - MYSQL_USER={{ db_user }}
            - MYSQL_PASSWORD={{ db_password }}
           volumes:
           db_data:
           driver: local
      when: state == 'present'

    - name: Start Docker Compose
      command: docker-compose up -d
      args:
       chdir: "/path/to/{{ project_name }}"
      when: state == 'present'

    - name: Remove Docker Compose and its entities
      command: docker-compose down —volumes —remove-orphans
      args:
       chdir: "/path/to/{{ project_name }}"
      when: state == 'absent'

    - name: Remove docker-compose.yml
      file:
       path: "/path/to/{{ project_name }}/docker-compose.yml"
       state: absent
      when: state == 'absent'
