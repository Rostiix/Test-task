-name: Manage users
 hosts: all
 become: true
 vars_files:
  - vars/users_vars.yml
 tasks:
  - name: Ensure user is present
    user:
     name: "{{username}}"
     state: "{{state}}"
     groups: "{{groups | join(',') | default(omit)}}"
     ssh_key: "{{ lookup('file', ssh_key) | default(omit)}}"
     remove: "{{ state == 'absent' }}"
  - name: Remove user home directory
    file:
     path: "/home/{{username}}"
     state: absent
    when: state == 'absent'